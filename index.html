<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>가중치 룰렛 추첨기</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 30px; }
    canvas { border-radius: 50%; border: 2px solid #333; transition: transform 3s ease-out; }
    button {margin-top: 30px;}
    .arrow {
      position: absolute;
      top: 50%;
      left: 15px;
      transform: translate(-100%, -50%) rotate(90deg);
      width: 0;
      height: 0;
      border-left: 20px solid transparent;
      border-right: 20px solid transparent;
      border-bottom: 30px solid red;
      z-index: 10;
    }
    .container {
      position: relative;
      width: 500px;
      height: 500px;
      margin: 0 auto;
    }
    .results { margin-top: 30px; }
    h3 { margin-bottom: 5px; }
    ul { padding-left: 0; list-style: none; }
    .winner-popup {
      font-size: 28px;
      font-weight: bold;
      color: #d32f2f;
      animation: pop 1s ease-out;
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 999;
    }
    @keyframes pop {
      0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
      60% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
  </style>
</head>
<body>

  <h2>예투 가입하면 100만원 이벤트 룰렛</h2>
  <div style="display: flex; flex-direction: row; gap: 100px; justify-content: center; align-items: center; margin-top: 30px;">
    <div class="containter2">
    <div class="container">
        <div class="arrow"></div>
        <canvas id="wheel" width="500" height="500"></canvas>
        <div id="popup" class="winner-popup" style="display:none;"></div>
    </div>
    <button onclick="startDraw()">추첨 시작</button>
    </div>
  <div class="results" style="height: 100%;">
    <h3>👑 2등 (10명)</h3><ul id="second"></ul>
    <h3>🎉 3등 (20명)</h3><ul id="third"></ul>
  </div>
</div>

<div style="margin-top: 100px; padding: 20px;">
  <h4 style="font-weight: normal; color: #999;">※ 아래 명단은 관리자용입니다. (드래그해서 복사 가능)</h4>
  <pre id="adminWinnerLog" style="user-select: text; color: white; background: white; font-size: 14px; overflow-x: auto; white-space: pre-wrap;"></pre>
</div>

<script>
const participants = [
  { name: "류*영", tickets: 5, email: "juyoung.ryu@evertreasure.xyz" },
  { name: "임*진", tickets: 1, email: "peter.im@evertreasure.xyz" },
  { name: "구*정", tickets: 27, email: "hyunjung.koo@evertreasure.xyz" },
  { name: "박*하", tickets: 3, email: "uni08ray@gmail.com" },
  { name: "남*현", tickets: 1, email: "jinhyunnam@gmail.com" },
  { name: "강*규", tickets: 1, email: "bokyukang81@gmail.com" },
  { name: "S******", tickets: 1, email: "sean.gn7@gmail.com" },
  { name: "박*수", tickets: 1, email: "jisubag199@gmail.com" },
  { name: "조*린", tickets: 11, email: "everine.jo@evertreasure.xyz" },
  { name: "서*연", tickets: 1, email: "tnsjrnfl@naver.com" },
  { name: "변*을", tickets: 8, email: "autumn.byun@evertreasure.xyz" },
  //{ name: "함*미", tickets: 2, email: "youjin33333@gmail.com" },
  { name: "변*선", tickets: 2, email: "bgs5908@gmail.com" },
  { name: "J******", tickets: 7, email: "stylish.jk@gmail.com" },
  { name: "조*현", tickets: 2, email: "hyuntae60@gmail.com" },
  { name: "공*현", tickets: 2, email: "rhdtmddnr1@naver.com" },
  { name: "l******", tickets: 2, email: "lunarisdh@gmail.com" },
  { name: "김*원", tickets: 2, email: "ksw6962@naver.com" },
  { name: "1*******", tickets: 2, email: "11yjh11@naver.com" },
  { name: "t****", tickets: 1, email: "trumc@naver.com" },
  { name: "조*선", tickets: 2, email: "minseonjo453@gmail.com" },
  { name: "박*민", tickets: 1, email: "begum75737540@gmail.com" },
  { name: "하*", tickets: 2, email: "weds01125@gmail.com" },
  { name: "김*우", tickets: 1, email: "lovebabyny@naver.com" },
  { name: "염*훈", tickets: 1, email: "yeomjh0@gmail.com" },
  { name: "e****", tickets: 1, email: "eris9@daum.net" },
  { name: "이*영", tickets: 1, email: "junyoung2691@naver.com" },
  { name: "김*우", tickets: 1, email: "wooki.creator@gmail.com" },
  { name: "김*신", tickets: 1, email: "entia2004@naver.com" },
  { name: "김*현", tickets: 2, email: "seohyeon.kim@evertreasure.xyz" },
  { name: "영*", tickets: 2, email: "shinpark98@daum.net" },
  { name: "b********", tickets: 2, email: "blueraindrops@hanmail.net" },
  { name: "최*식", tickets: 3, email: "centmania1013@gmail.com" },
  { name: "이*영", tickets: 2, email: "leebona1015@gmail.com" },
  { name: "허*현", tickets: 2, email: "hankheo@naver.com" }
];

const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const popup = document.getElementById("popup");
let ticketPool = [];
let currentWinners = new Set();
let rotation = 0;

function buildTicketPool() {
  ticketPool = [];
  participants.forEach(p => {
    if (!currentWinners.has(p.name)) {
      for (let i = 0; i < p.tickets; i++) {
        ticketPool.push(p.name);
      }
    }
  });
}

function drawWheel() {
  ctx.clearRect(0, 0, 500, 500);
  let total = ticketPool.length;
  let counts = {};
  ticketPool.forEach(name => counts[name] = (counts[name] || 0) + 1);
  let uniqueNames = Object.keys(counts);
  let startAngle = 0;
  uniqueNames.forEach((name, i) => {
    const slice = (counts[name] / total) * Math.PI * 2;
    ctx.beginPath();
    ctx.moveTo(250, 250);
    ctx.arc(250, 250, 250, startAngle, startAngle + slice);
    ctx.fillStyle = `hsl(${i * 25}, 70%, 60%)`;
    ctx.fill();
    ctx.save();
    ctx.translate(250, 250);
    ctx.rotate(startAngle + slice / 2);
    ctx.textAlign = "right";
    ctx.fillStyle = "#000";
    ctx.font = "14px sans-serif";
    ctx.fillText(name, 230, 0);
    ctx.restore();
    startAngle += slice;
  });
}

function spinOnce(prizeLevel, ulId) {
  return new Promise(resolve => {
    buildTicketPool();
    drawWheel();

    const randIndex = Math.floor(Math.random() * ticketPool.length);
    const chosenName = ticketPool[randIndex];
    let total = ticketPool.length;
    let counts = {};
    ticketPool.forEach(name => counts[name] = (counts[name] || 0) + 1);
    let uniqueNames = Object.keys(counts);

    let startAngle = 0;
    let chosenAngle = 0;
    for (let name of uniqueNames) {
      const slice = (counts[name] / total) * 360;
      if (name === chosenName) {
        chosenAngle = startAngle + slice / 2;
        break;
      }
      startAngle += slice;
    }

    const targetAngle = 180;
    const currentRotation = rotation % 360;
    const delta = (360 + targetAngle - chosenAngle - currentRotation) % 360;
    const spinAngle = 360 * 5 + delta;
    rotation += spinAngle;
    canvas.style.transform = `rotate(${rotation}deg)`;

    setTimeout(() => {
      currentWinners.add(chosenName);
      const ul = document.getElementById(ulId);
      const li = document.createElement("li");
      li.textContent = chosenName;
      ul.appendChild(li);

      popup.textContent = `🎉 ${chosenName} 당첨!`;
      popup.style.display = 'block';
      setTimeout(() => popup.style.display = 'none', 2000);

      const winnerInfo = participants.find(p => p.name === chosenName);
      if (winnerInfo) {
        const entry = `${prizeLevel} - ${winnerInfo.name} (${winnerInfo.email})\n`;
        document.getElementById("adminWinnerLog").textContent += entry;
      }

      resolve();
    }, 5000);
  });
}

async function startDraw() {
  currentWinners = new Set();
  document.getElementById("second").innerHTML = "";
  document.getElementById("third").innerHTML = "";
  document.getElementById("adminWinnerLog").textContent = "";
  rotation = 0;

  buildTicketPool();
  drawWheel();

  for (let i = 0; i < 10; i++) {
    await spinOnce("2등", "second");
  }
  for (let i = 0; i < 20; i++) {
    await spinOnce("3등", "third");
  }
}

buildTicketPool();
drawWheel();
</script>
</body>
</html>